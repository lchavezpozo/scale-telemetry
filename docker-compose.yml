services:
  # Servicio de telemetría
  scale-telemetry:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: scale-telemetry
    env_file:
      - .env
    environment:
      # Sobreescrituras específicas de Docker (si se necesitan)
      # Para socat: usa /tmp/ttyV0
      # Para hardware real: usa /dev/ttyUSB0 o similar
      - SERIAL_PORT=${SERIAL_PORT:-/tmp/ttyV0}
    
    # devices:
      # NOTA: No funciona con enlaces simbólicos de socat (requiere privileged mode)
      # Para hardware real, descomenta y ajusta:
      # - /dev/ttyUSB0:/dev/ttyUSB0
      # - /dev/ttyACM0:/dev/ttyACM0
      # - /dev/cu.usbserial-1420:/dev/ttyUSB0
    
    # Para usar socat con enlaces simbólicos, necesitamos privileged mode
    # Para hardware real, cambia a false y usa devices arriba
    privileged: true
    
    restart: unless-stopped
    
    # Usar la red del host para acceder a servicios locales como EMQX
    # Opción 1: network_mode host (más simple si EMQX está en localhost)
    # network_mode: "host"
    # Opción 2: Red bridge (si EMQX está en otro contenedor o accesible por IP)
    networks:
      - scale-network
    
    volumes:
      - ./logs:/var/log/scale-telemetry
      - /tmp:/tmp  # Montar /tmp para acceder a los puertos socat
      - ./devices.json:/app/devices.json:ro  # Configuración de dispositivos

networks:
  scale-network:
    driver: bridge
